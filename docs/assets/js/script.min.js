var leftover=0,modal=null,timeout_id=null,interval_id=null,interval_modal=null,interval_set=!1,interval=localStorage.getItem("interval"),rotation=localStorage.getItem("rotation"),my_username=localStorage.getItem("username"),friends=JSON.parse(localStorage.getItem("friends"));const api_key="dd1a962f61082dd2e1037b35143d1440",endpoint="https://ws.audioscrobbler.com/2.0",card=$(".friend-card").clone().removeClass("visually-hidden");async function main(){if(null==friends){friends=[],createFriendCards((await get_friends(my_username)).friends.user)}else createFriendCardsFromNames();refresh()}function log_in(){$("#my-username").val().length?(my_username=$("#my-username").val(),localStorage.setItem("username",my_username),modal.hide(),main()):$("#my-username").focus()}function log_out(){localStorage.clear(),window.location.href="/"}function createFriendCards(e){let t=0,n=e.length;for(;t<n;){let n=e[t].name,r=card.clone().attr("id",n);r.find(".friend-link").attr("href","https://www.last.fm/user/"+n),r.find(".friend-username").text(n),$("#friends").append(r),friends.push(n),t++}localStorage.setItem("friends",JSON.stringify(friends))}function createFriendCardsFromNames(){friends.includes("kaangiray26")||friends.unshift("kaangiray26");let e=0,t=friends.length;for(;e<t;){let t=friends[e],n=card.clone().attr("id",t);n.find(".friend-link").attr("href","https://www.last.fm/user/"+t),n.find(".friend-username").text(t),$("#friends").append(n),e++}}async function get_friend_track(e){let t=await get_recent(e);if(!t.hasOwnProperty("recenttracks")||!t.recenttracks.track.length)return $("#"+e).remove(),void friends.splice(friends.indexOf(e),1);let n=$("#"+e);latest_track=t.recenttracks.track[0],latest_track.hasOwnProperty("@attr")?n.find(".live-button").removeClass("visually-hidden"):n.find(".live-button").addClass("visually-hidden");let r=latest_track.artist["#text"],a=latest_track.album["#text"],i=latest_track.name,l=latest_track.image[latest_track.image.length-1]["#text"],s=latest_track.url;l.length&&n.find(".image").attr("src",l).removeClass("placeholder"),n.find(".artist").text(r),n.find(".album").text(a),n.find(".track").text(i),n.find(".link").attr("href",s)}async function loading(){$("#refreshButton").css("transform","rotate("+rotation+"deg)"),timeout_id=setTimeout((function(){rotation=(rotation+1)%360,loading()}),1)}async function refresh(){console.log("Running refresh..."),leftover=friends.length,$("#refreshButton").css("color","#E4141E"),loading();let e=0,t=friends.length;for(;e<t;)get_friend_track(friends[e]),e++}async function show_interval_modal(){(interval_modal=new bootstrap.Modal("#interval-modal")).show()}async function stopRotation(){clearTimeout(timeout_id),$("#refreshButton").css("color","var(--bs-primary"),localStorage.setItem("rotation",rotation),interval_set||(interval_set=!0,start_interval(interval))}async function set_interval(){$("#interval-alert").addClass("visually-hidden");let e=$("#interval").val();if(e.length&&/^\d+$/.test(e)){if(parseInt(e)<10)return $("#interval-alert").removeClass("visually-hidden"),void $("#interval").focus();interval_modal.hide(),localStorage.setItem("interval",parseInt(e)),$("#interval").val(parseInt(e)),clearInterval(interval_id),start_interval(parseInt(e))}else $("#interval").focus()}async function start_interval(e){interval_id=setInterval(refresh,1e3*e),console.log("Interval set to "+e+" seconds.")}function get_friends(e){return fetch(`https://ws.audioscrobbler.com/2.0/?method=user.getfriends&user=${e}&api_key=${api_key}&format=json`,{method:"GET",headers:{Accept:"application/json"}}).then((e=>e.ok?e.json():{}))}function get_recent(e){return fetch(`https://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=${e}&api_key=${api_key}&format=json`,{method:"GET",headers:{Accept:"application/json"}}).then((e=>((leftover-=1)||stopRotation(),e.ok?e.json():{})))}rotation=null==rotation?0:parseInt(rotation),null==interval?(interval=30,localStorage.setItem("interval",interval)):($("#interval").val(interval),interval=parseInt(interval)),null==my_username?(modal=new bootstrap.Modal("#modal")).show():main(),$("#my-username").on("keyup",(function(e){"Enter"==e.key&&log_in()})),$("#interval").on("keyup",(function(e){"Enter"==e.key&&set_interval()}));